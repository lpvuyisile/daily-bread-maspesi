<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Bread - Verses for You</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;600&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .serif { font-family: 'Playfair Display', serif; }
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 1.5rem;
        }
        .emotion-btn {
            transition: all 0.2s ease;
        }
        .emotion-btn:hover {
            transform: translateY(-2px);
            filter: brightness(0.95);
        }
        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-3xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-12 fade-in">
            <h1 class="serif text-4xl md:text-5xl font-bold text-slate-800 mb-2">Daily Bread</h1>
            <p class="text-slate-600 italic mb-4">"Man shall not live by bread alone, but by every word of God."</p>
            <div id="greeting-area" class="text-xl font-medium text-indigo-700 serif">
                <span id="time-greeting"></span> Maspesi
            </div>
        </header>

        <!-- Verse of the Day Section -->
        <section id="daily-section" class="glass p-8 mb-8 shadow-xl fade-in">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-semibold uppercase tracking-widest text-indigo-600">Verse of the Day</h2>
                <span id="current-date" class="text-xs text-slate-400"></span>
            </div>
            <div id="daily-verse-container" class="text-center min-h-[120px] flex flex-col justify-center">
                <p id="daily-text" class="serif text-2xl text-slate-700 leading-relaxed mb-4">Loading your daily bread...</p>
                <cite id="daily-ref" class="text-slate-500 font-semibold"></cite>
            </div>
        </section>

        <!-- Emotion Selector & Input Section -->
        <section class="glass p-8 shadow-xl fade-in" style="animation-delay: 0.2s">
            <h2 class="serif text-2xl font-bold text-slate-800 mb-6 text-center">How are you feeling, Maspesi?</h2>
            
            <!-- Predefined Emotions -->
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-8" id="emotion-grid">
                <!-- Buttons generated by JS -->
            </div>

            <!-- Custom Description Input -->
            <div class="mb-8 p-4 bg-white/50 rounded-xl border border-dashed border-indigo-200">
                <p class="text-sm text-slate-500 mb-3 text-center">Or share your heart in detail:</p>
                <div class="flex flex-col gap-3">
                    <textarea id="custom-feeling" rows="2" class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-indigo-400 focus:border-transparent outline-none text-slate-700 resize-none" placeholder="e.g. I am feeling a bit overwhelmed and need some peace today..."></textarea>
                    <button id="find-verse-btn" onclick="handleCustomFeeling()" class="bg-indigo-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-indigo-700 transition-all flex items-center justify-center gap-2">
                        Find a Verse
                    </button>
                </div>
            </div>

            <div id="emotion-result" class="hidden border-t border-slate-200 pt-8 text-center fade-in">
                <div class="inline-block p-2 px-4 bg-indigo-50 text-indigo-600 rounded-full text-xs font-bold uppercase mb-4" id="selected-emotion-tag"></div>
                <div id="verse-content">
                    <p id="emotion-text" class="serif text-xl text-slate-700 leading-relaxed mb-4"></p>
                    <cite id="emotion-ref" class="text-slate-500 font-semibold"></cite>
                </div>
                <div class="mt-6">
                    <button id="retry-btn" onclick="retryLastRequest()" class="text-sm text-indigo-500 hover:text-indigo-700 transition-colors">
                        <i class="fa-solid fa-rotate-right mr-1"></i> Give me another one
                    </button>
                </div>
            </div>
        </section>

        <footer class="text-center mt-12 text-slate-500 text-sm">
            <p>Made with love & prayers for Maspesi.</p>
        </footer>
    </div>

    <script>
        const apiKey = ""; 
        
        // Curated references known for strong presence in KJV/NIV
        const emotionMap = {
            "Happy": ["Psalm 118:24", "Philippians 4:4", "Psalm 126:2", "Psalm 100:2", "Proverbs 17:22", "1 Thessalonians 5:16"],
            "Anxious": ["Philippians 4:6-7", "1 Peter 5:7", "Psalm 34:4", "Matthew 6:34", "Isaiah 41:10", "Psalm 56:3"],
            "Sad": ["Psalm 34:18", "Matthew 5:4", "Psalm 147:3", "John 16:22", "Psalm 30:5", "Revelation 21:4"],
            "Weak": ["Isaiah 40:31", "2 Corinthians 12:9", "Philippians 4:13", "Psalm 73:26", "Nehemiah 8:10", "Psalm 18:2"],
            "Lonely": ["Deuteronomy 31:6", "Psalm 27:10", "Isaiah 43:2", "Matthew 28:20", "Psalm 23:4", "Hebrews 13:5"],
            "Angry": ["James 1:19-20", "Ephesians 4:26", "Proverbs 15:1", "Proverbs 16:32", "Psalm 37:8", "Colossians 3:8"],
            "Thankful": ["1 Thessalonians 5:18", "Psalm 107:1", "Colossians 3:17", "Psalm 95:2", "Psalm 118:1", "Ephesians 5:20"],
            "Fearful": ["Psalm 56:3", "2 Timothy 1:7", "Psalm 23:4", "Isaiah 41:13", "Psalm 27:1", "Joshua 1:9"]
        };

        const emotionColors = {
            "Happy": "bg-yellow-100 text-yellow-700",
            "Anxious": "bg-blue-100 text-blue-700",
            "Sad": "bg-indigo-100 text-indigo-700",
            "Weak": "bg-emerald-100 text-emerald-700",
            "Lonely": "bg-purple-100 text-purple-700",
            "Angry": "bg-red-100 text-red-700",
            "Thankful": "bg-orange-100 text-orange-700",
            "Fearful": "bg-slate-200 text-slate-700",
            "Custom": "bg-indigo-600 text-white"
        };

        let currentRequestMode = ""; 
        let currentEmotion = "";
        let currentCustomDescription = "";

        function setGreeting() {
            const hour = new Date().getHours();
            let greeting = "Good Evening";
            if (hour < 12) greeting = "Good Morning";
            else if (hour < 18) greeting = "Good Afternoon";
            document.getElementById('time-greeting').innerText = greeting;
        }

        async function fetchVerse(reference) {
            let retries = 0;
            const delays = [1000, 2000, 4000, 8000, 16000];
            while (retries < 5) {
                try {
                    // Force KJV translation in the API call for consistency
                    const response = await fetch(`https://bible-api.com/${encodeURIComponent(reference)}?translation=kjv`);
                    if (!response.ok) throw new Error("API Limit");
                    const data = await response.json();
                    return data;
                } catch (error) {
                    if (retries === 4) return null;
                    await new Promise(res => setTimeout(res, delays[retries]));
                    retries++;
                }
            }
        }

        async function callGemini(prompt) {
            let retries = 0;
            const delays = [1000, 2000, 4000, 8000, 16000];
            while (retries < 5) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: "You are a biblical assistant. Identify ONE specific Bible verse (from KJV or NIV standard Protestant canon) that matches the user's feelings. Output ONLY the reference (e.g., 'Psalm 23:1') and nothing else. Ensure the verse is different if the user asks for another one." }] }
                        })
                    });
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                } catch (error) {
                    if (retries === 4) return null;
                    await new Promise(res => setTimeout(res, delays[retries]));
                    retries++;
                }
            }
        }

        async function loadDailyVerse() {
            const date = new Date();
            document.getElementById('current-date').innerText = date.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
            const dailyVerses = ["Lamentations 3:22-23", "Jeremiah 29:11", "Romans 8:28", "Proverbs 3:5-6", "Psalm 46:1", "John 14:6", "Matthew 11:28", "Psalm 23:1"];
            const start = new Date(date.getFullYear(), 0, 0);
            const diff = date - start;
            const oneDay = 1000 * 60 * 60 * 24;
            const dayOfYear = Math.floor(diff / oneDay);
            const ref = dailyVerses[dayOfYear % dailyVerses.length];
            const verse = await fetchVerse(ref);
            if (verse) {
                document.getElementById('daily-text').innerText = verse.text.trim();
                document.getElementById('daily-ref').innerText = verse.reference;
            }
        }

        async function getEmotionVerse(emotion) {
            currentRequestMode = "button";
            currentEmotion = emotion;
            showResultLoading(emotion);
            const pool = emotionMap[emotion];
            const randomRef = pool[Math.floor(Math.random() * pool.length)];
            const verse = await fetchVerse(randomRef);
            displayVerseResult(verse);
        }

        async function handleCustomFeeling() {
            const description = document.getElementById('custom-feeling').value.trim();
            if (!description) return;
            currentRequestMode = "text";
            currentCustomDescription = description;
            const findBtn = document.getElementById('find-verse-btn');
            findBtn.disabled = true;
            findBtn.innerHTML = `<span class="loading-spinner"></span> Seeking...`;
            showResultLoading("Your Heart");
            const reference = await callGemini(`The user feels: "${description}". Find a supportive Bible verse reference from KJV/NIV.`);
            if (reference) {
                const verse = await fetchVerse(reference);
                displayVerseResult(verse);
            } else {
                displayError();
            }
            findBtn.disabled = false;
            findBtn.innerText = "Find a Verse";
        }

        function retryLastRequest() {
            if (currentRequestMode === "button") getEmotionVerse(currentEmotion);
            else handleCustomFeeling();
        }

        function showResultLoading(tag) {
            const resultDiv = document.getElementById('emotion-result');
            const tagEl = document.getElementById('selected-emotion-tag');
            resultDiv.classList.remove('hidden');
            document.getElementById('emotion-text').innerHTML = `<span class="loading-spinner"></span> Seeking His Word...`;
            document.getElementById('emotion-ref').innerText = "";
            tagEl.innerText = tag;
            tagEl.className = `inline-block p-2 px-4 rounded-full text-xs font-bold uppercase mb-4 ${emotionColors[tag] || emotionColors.Custom}`;
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function displayVerseResult(verse) {
            if (verse) {
                document.getElementById('emotion-text').innerText = verse.text.trim();
                document.getElementById('emotion-ref').innerText = verse.reference;
            } else {
                displayError();
            }
        }

        function displayError() {
            document.getElementById('emotion-text').innerText = "I couldn't reach the Word right now. Please try again in a moment.";
        }

        function init() {
            setGreeting();
            const grid = document.getElementById('emotion-grid');
            Object.keys(emotionMap).forEach(emotion => {
                const btn = document.createElement('button');
                btn.className = 'emotion-btn p-3 rounded-xl border border-slate-200 bg-white shadow-sm hover:shadow-md font-medium text-slate-700 text-sm';
                btn.innerText = emotion;
                btn.onclick = () => getEmotionVerse(emotion);
                grid.appendChild(btn);
            });
            loadDailyVerse();
        }
        window.onload = init;
    </script>
</body>
</html>
